<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Watercolor Wizard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Essential CSS to prevent layout shifts */
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-stone-50 text-slate-800 font-sans selection:bg-blue-100 pb-20">

    <!-- This loading screen is pure HTML, so it shows up IMMEDIATELY -->
    <div id="app">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #64748b;">
            <div class="loader"></div>
            <p class="mt-4 font-medium">Mixing Paints...</p>
        </div>
    </div>

    <!-- We use ES Modules for modern, crash-resistant loading -->
    <script type="module">
        import { h, render } from 'https://esm.sh/preact@10.19.3';
        import { useState, useMemo, useEffect } from 'https://esm.sh/preact@10.19.3/hooks';
        import htm from 'https://esm.sh/htm@3.1.1';

        // Initialize htm with preact
        const html = htm.bind(h);

        // --- ICONS ---
        const Icon = ({ path, size = 24, className = "" }) => html`
            <svg xmlns="http://www.w3.org/2000/svg" width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class=${className}>
                ${path}
            </svg>
        `;

        const Icons = {
            Droplets: (props) => html`<${Icon} ...${props} path=${html`<path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/>`} />`,
            Plus: (props) => html`<${Icon} ...${props} path=${html`<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>`} />`,
            X: (props) => html`<${Icon} ...${props} path=${html`<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>`} />`,
            Book: (props) => html`<${Icon} ...${props} path=${html`<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>`} />`,
            Refresh: (props) => html`<${Icon} ...${props} path=${html`<path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>`} />`
        };

        // --- COLOR LOGIC ---
        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:0,g:0,b:0};
        };

        const rgbToHex = (r, g, b) => "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);

        const rgbToLab = (rgb) => {
            let r = rgb.r / 255, g = rgb.g / 255, b = rgb.b / 255;
            r = (r > 0.04045) ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
            g = (g > 0.04045) ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
            b = (b > 0.04045) ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;
            let x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
            let y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.00000;
            let z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;
            x = (x > 0.008856) ? Math.pow(x, 1/3) : (7.787 * x) + 16/116;
            y = (y > 0.008856) ? Math.pow(y, 1/3) : (7.787 * y) + 16/116;
            z = (z > 0.008856) ? Math.pow(z, 1/3) : (7.787 * z) + 16/116;
            return { L: (116 * y) - 16, a: 500 * (x - y), b: 200 * (y - z) };
        };

        const mixColors = (colors, ratios) => {
            let totalRatio = ratios.reduce((a, b) => a + b, 0);
            let avgR = 0, avgG = 0, avgB = 0;
            colors.forEach((c, i) => {
                avgR += c.rgb.r * (ratios[i] / totalRatio);
                avgG += c.rgb.g * (ratios[i] / totalRatio);
                avgB += c.rgb.b * (ratios[i] / totalRatio);
            });
            const isWhiteMix = colors.every(c => c.id === 'white');
            const darknessFactor = isWhiteMix ? 1.0 : 0.92; // Slightly darker to simulate subtractive
            return { 
                r: Math.min(255, Math.max(0, Math.round(avgR * darknessFactor))), 
                g: Math.min(255, Math.max(0, Math.round(avgG * darknessFactor))), 
                b: Math.min(255, Math.max(0, Math.round(avgB * darknessFactor))) 
            };
        };

        const COMMON_PIGMENTS = [
            { id: 'cad-red', name: 'Cadmium Red', hex: '#E30022' },
            { id: 'alizarin', name: 'Alizarin Crimson', hex: '#E32636' },
            { id: 'lemon', name: 'Lemon Yellow', hex: '#FFF44F' },
            { id: 'cad-yellow', name: 'Cadmium Yellow', hex: '#FFF600' },
            { id: 'yellow-ochre', name: 'Yellow Ochre', hex: '#CC7722' },
            { id: 'sap-green', name: 'Sap Green', hex: '#507D2A' },
            { id: 'viridian', name: 'Viridian', hex: '#40826D' },
            { id: 'cobalt', name: 'Cobalt Blue', hex: '#0047AB' },
            { id: 'ultramarine', name: 'Ultramarine', hex: '#4166F5' }, 
            { id: 'burnt-sienna', name: 'Burnt Sienna', hex: '#E97451' },
            { id: 'burnt-umber', name: 'Burnt Umber', hex: '#8A3324' },
            { id: 'paynes', name: 'Payne\'s Grey', hex: '#536878' },
            { id: 'white', name: 'Paper (White)', hex: '#FFFFFF' }, 
        ];

        const INIT_PALETTE = COMMON_PIGMENTS.filter(p => ['cad-red', 'lemon', 'ultramarine', 'burnt-sienna', 'white'].includes(p.id));

        // --- COMPONENTS ---
        
        const App = () => {
            const [targetHex, setTargetHex] = useState('#8B5A2B');
            const [palette, setPalette] = useState(INIT_PALETTE);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showTheory, setShowTheory] = useState(false);

            const targetLab = useMemo(() => rgbToLab(hexToRgb(targetHex)), [targetHex]);

            const bestMix = useMemo(() => {
                let bestDist = Infinity, bestRecipe = null, bestResultHex = '#ffffff';
                const paletteWithRgb = palette.map(p => ({ ...p, rgb: hexToRgb(p.hex) }));
                
                const checkMix = (indices, parts) => {
                    const selectedColors = indices.map(i => paletteWithRgb[i]);
                    const mixedRgb = mixColors(selectedColors, parts);
                    const dist = Math.sqrt(
                        Math.pow(targetLab.L - rgbToLab(mixedRgb).L, 2) + 
                        Math.pow(targetLab.a - rgbToLab(mixedRgb).a, 2) + 
                        Math.pow(targetLab.b - rgbToLab(mixedRgb).b, 2)
                    );
                    if (dist < bestDist) {
                        bestDist = dist;
                        bestResultHex = rgbToHex(mixedRgb.r, mixedRgb.g, mixedRgb.b);
                        bestRecipe = indices.map((idx, i) => ({ color: palette[idx], parts: parts[i] }));
                    }
                };

                // Fast simplified search
                for (let i = 0; i < paletteWithRgb.length; i++) checkMix([i], [1]);
                const ratios2 = [[1,1], [2,1], [1,2], [4,1], [1,4]];
                for (let i = 0; i < paletteWithRgb.length; i++) {
                    for (let j = i + 1; j < paletteWithRgb.length; j++) {
                        for (let r of ratios2) checkMix([i, j], r);
                    }
                }
                // Only try 3 colors if bad match
                if (bestDist > 12) {
                     const ratios3 = [[1,1,1], [2,1,1], [1,2,1], [1,1,2]];
                     for (let i=0; i<Math.min(paletteWithRgb.length, 6); i++) {
                        for (let j=i+1; j<paletteWithRgb.length; j++) {
                             for (let k=j+1; k<paletteWithRgb.length; k++) {
                                 for(let r of ratios3) checkMix([i,j,k], r);
                             }
                        }
                     }
                }

                return { recipe: bestRecipe, resultHex: bestResultHex, accuracy: Math.max(0, 100 - bestDist * 1.5) };
            }, [targetHex, palette]);

            const addToPalette = (p) => {
                if (!palette.find(x => x.id === p.id)) setPalette([...palette, p]);
                setShowAddModal(false);
            };

            return html`
                <div className="min-h-screen bg-stone-50">
                    <header className="bg-white border-b border-stone-200 sticky top-0 z-20 px-4 py-3 shadow-sm flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-500 text-white p-2 rounded-lg">
                                <${Icons.Droplets} size=${20} />
                            </div>
                            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">Watercolor Wizard</h1>
                        </div>
                        <button onClick=${() => setShowTheory(!showTheory)} className="text-slate-500 hover:text-blue-600">
                            <${Icons.Book} size=${24} />
                        </button>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-6">
                        <!-- TARGET SELECTOR -->
                        <section className="bg-white rounded-2xl p-6 shadow-sm border border-stone-100">
                            <h2 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">1. Target Color</h2>
                            <div className="relative h-24 rounded-xl shadow-inner border border-stone-200 w-full overflow-hidden">
                                <input type="color" value=${targetHex} onInput=${(e) => setTargetHex(e.target.value)} 
                                       className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                <div className="absolute inset-0 flex items-center justify-center text-white font-bold text-shadow-sm pointer-events-none"
                                     style=${{ backgroundColor: targetHex, textShadow: '0 1px 3px rgba(0,0,0,0.3)' }}>
                                    Tap to Pick Color
                                </div>
                            </div>
                        </section>

                        <!-- PALETTE -->
                        <section>
                            <div className="flex items-center justify-between mb-3">
                                <h2 className="text-xs font-bold text-slate-400 uppercase tracking-wider">2. Your Palette</h2>
                                <button onClick=${() => setShowAddModal(true)} className="text-xs bg-stone-100 text-stone-600 px-3 py-1 rounded-full font-medium hover:bg-blue-100 hover:text-blue-600 transition-colors">
                                    + Add Paint
                                </button>
                            </div>
                            <div className="flex flex-wrap gap-3 bg-white p-4 rounded-2xl border border-stone-100 shadow-sm">
                                ${palette.map(p => html`
                                    <div key=${p.id} className="relative group" onClick=${() => p.id !== 'white' && setPalette(palette.filter(x => x.id !== p.id))}>
                                        <div className="w-12 h-12 rounded-full border-2 shadow-sm transition-transform active:scale-95" 
                                             style=${{ backgroundColor: p.hex, borderColor: 'rgba(0,0,0,0.1)' }}></div>
                                        ${p.id !== 'white' ? html`<div className="absolute -top-1 -right-1 bg-white text-red-500 rounded-full shadow p-0.5 opacity-0 group-hover:opacity-100"><${Icons.X} size=${12} /></div>` : ''}
                                    </div>
                                `)}
                                <button onClick=${() => setShowAddModal(true)} className="w-12 h-12 rounded-full border-2 border-dashed border-stone-300 flex items-center justify-center text-stone-400">
                                    <${Icons.Plus} size=${20} />
                                </button>
                            </div>
                        </section>

                        <!-- RESULTS -->
                        <section className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 shadow-md border border-blue-100">
                            <h2 className="text-xs font-bold text-blue-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                                <${Icons.Refresh} size=${14} /> Mix Recipe
                            </h2>
                            
                            <div className="flex items-center justify-center gap-4 mb-6">
                                <div className="text-center">
                                    <div className="w-16 h-16 rounded-full border-2 border-white shadow-sm mx-auto mb-1" style=${{backgroundColor: targetHex}}></div>
                                    <span className="text-xs text-slate-500">Goal</span>
                                </div>
                                <div className="text-slate-300">âžœ</div>
                                <div className="text-center relative">
                                    <div className="w-16 h-16 rounded-full border-2 border-white shadow-sm mx-auto mb-1" style=${{backgroundColor: bestMix.resultHex}}></div>
                                    <span className="text-xs text-slate-500">Result</span>
                                    <div className="absolute -top-2 -right-2 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">
                                        ${Math.round(bestMix.accuracy)}% Match
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white/60 p-4 rounded-xl space-y-3 backdrop-blur-sm">
                                ${bestMix.recipe ? bestMix.recipe.map(step => html`
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="w-6 h-6 rounded-full border border-stone-200" style=${{backgroundColor: step.color.hex}}></div>
                                            <span className="font-medium text-slate-700 text-sm">${step.color.name}</span>
                                        </div>
                                        <div>
                                            <span className="text-lg font-bold text-blue-600">${step.parts}</span>
                                            <span className="text-[10px] text-slate-400 uppercase ml-1">Part</span>
                                        </div>
                                    </div>
                                `) : html`<div className="text-center text-slate-400">Loading...</div>`}
                            </div>
                        </section>
                    </main>

                    <!-- MODAL -->
                    ${showAddModal ? html`
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm" onClick=${() => setShowAddModal(false)}>
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden" onClick=${e => e.stopPropagation()}>
                                <div className="p-4 border-b border-stone-100 flex justify-between bg-stone-50">
                                    <h3 className="font-bold text-slate-700">Add Paint</h3>
                                    <button onClick=${() => setShowAddModal(false)}><${Icons.X} size=${20} /></button>
                                </div>
                                <div className="p-2 max-h-[60vh] overflow-y-auto">
                                    ${COMMON_PIGMENTS.filter(cp => !palette.some(p => p.id === cp.id)).map(pigment => html`
                                        <button onClick=${() => addToPalette(pigment)} className="w-full flex items-center gap-3 p-3 hover:bg-blue-50 rounded-xl transition-colors">
                                            <div className="w-8 h-8 rounded-full border border-stone-200" style=${{backgroundColor: pigment.hex}}></div>
                                            <span className="font-medium text-slate-700">${pigment.name}</span>
                                            <div className="ml-auto text-stone-300"><${Icons.Plus} size=${16} /></div>
                                        </button>
                                    `)}
                                    ${COMMON_PIGMENTS.every(cp => palette.some(p => p.id === cp.id)) ? html`<div className="p-4 text-center text-slate-400 text-sm">All paints added!</div>` : ''}
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- THEORY -->
                    ${showTheory ? html`
                        <div className="fixed inset-0 z-50 flex justify-end">
                            <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick=${() => setShowTheory(false)}></div>
                            <div className="relative w-full max-w-sm bg-white h-full shadow-2xl p-6 overflow-y-auto">
                                <button onClick=${() => setShowTheory(false)} className="absolute top-4 right-4 p-2 bg-stone-100 rounded-full"><${Icons.X} size=${20} /></button>
                                <h2 className="text-xl font-bold mb-6 text-blue-600">Quick Tips</h2>
                                <div className="space-y-6">
                                    <div>
                                        <h3 className="font-bold text-slate-800">1. Making Shadows</h3>
                                        <p className="text-sm text-slate-600 mt-1">Don't use black! Mix opposites. <br/>Red + Green = Shadow.</p>
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-slate-800">2. Water = White</h3>
                                        <p className="text-sm text-slate-600 mt-1">"Paper (White)" in this app means adding water to dilute the paint.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        };

        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>


