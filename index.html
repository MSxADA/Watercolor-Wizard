<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watercolor Wizard</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React and ReactDOM (Version 18) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Load Babel (to process JSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        
        @keyframes slide-in-right { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .animate-slide-in-right { animation: slide-in-right 0.3s ease-out; }

        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-stone-50 text-slate-800 font-sans selection:bg-blue-100">

    <!-- 4. Error & Loading Container -->
    <div id="root">
        <div style="text-align: center; padding-top: 50px; font-family: sans-serif; color: #666;">
            <div class="loader"></div>
            <p>Loading Watercolor Wizard...</p>
        </div>
    </div>

    <!-- 5. Error Handler Script -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="color: red; padding: 20px; max-width: 600px; margin: 0 auto; background: #fff; border: 1px solid red; border-radius: 8px;">
                    <h3 style="margin-top:0">Ouch! Something went wrong.</h3>
                    <p><strong>Error:</strong> ${message}</p>
                    <p><strong>Line:</strong> ${lineno}</p>
                    <p style="font-size: 0.9em; color: #555;">Please try refreshing the page. If this persists, the browser might be blocking the scripts.</p>
                </div>
            `;
            console.error("App Error:", error);
        };
    </script>

    <!-- 6. Main Application Logic -->
    <script type="text/babel">
        // Safe access to React globals
        const { useState, useEffect, useMemo } = React;

        // --- Icons (Inline SVGs to ensure no dependency issues) ---
        const IconBase = ({ size = 24, className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Droplets = (props) => (
            <IconBase {...props}><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></IconBase>
        );
        const Plus = (props) => ( <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase> );
        const XIcon = (props) => ( <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase> );
        const BookOpen = (props) => ( <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase> );
        const RefreshCw = (props) => ( <IconBase {...props}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase> );

        // --- Color Math ---
        const hexToRgb = (hex) => {
            if(!hex) return {r:0, g:0, b:0};
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : {r:0, g:0, b:0};
        };

        const rgbToHex = (r, g, b) => "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);

        const rgbToLab = (rgb) => {
            let r = rgb.r / 255, g = rgb.g / 255, b = rgb.b / 255;
            r = (r > 0.04045) ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
            g = (g > 0.04045) ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
            b = (b > 0.04045) ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;
            let x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
            let y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.00000;
            let z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;
            x = (x > 0.008856) ? Math.pow(x, 1/3) : (7.787 * x) + 16/116;
            y = (y > 0.008856) ? Math.pow(y, 1/3) : (7.787 * y) + 16/116;
            z = (z > 0.008856) ? Math.pow(z, 1/3) : (7.787 * z) + 16/116;
            return { L: (116 * y) - 16, a: 500 * (x - y), b: 200 * (y - z) };
        };

        const deltaE = (labA, labB) => {
            const deltaL = labA.L - labB.L;
            const deltaA = labA.a - labB.a;
            const deltaB = labA.b - labB.b;
            return Math.sqrt(deltaL * deltaL + deltaA * deltaA + deltaB * deltaB);
        };

        const mixColors = (colors, ratios) => {
            let r = 0, g = 0, b = 0;
            let totalRatio = ratios.reduce((a, b) => a + b, 0);
            const normRatios = ratios.map(r => r / totalRatio);
            let avgR = 0, avgG = 0, avgB = 0;
            colors.forEach((c, i) => {
                avgR += c.rgb.r * normRatios[i];
                avgG += c.rgb.g * normRatios[i];
                avgB += c.rgb.b * normRatios[i];
            });
            // Simple subtractive simulation: darken slightly if not white
            // This is a heuristic for "paint muddiness"
            const isWhiteMix = colors.every(c => c.id === 'white');
            const darknessFactor = isWhiteMix ? 1.0 : 0.95; 
            
            return { 
                r: Math.min(255, Math.max(0, Math.round(avgR * darknessFactor))), 
                g: Math.min(255, Math.max(0, Math.round(avgG * darknessFactor))), 
                b: Math.min(255, Math.max(0, Math.round(avgB * darknessFactor))) 
            };
        };

        const COMMON_PIGMENTS = [
            { id: 'cad-red', name: 'Cadmium Red', hex: '#E30022' },
            { id: 'alizarin', name: 'Alizarin Crimson', hex: '#E32636' },
            { id: 'lemon', name: 'Lemon Yellow', hex: '#FFF44F' },
            { id: 'cad-yellow', name: 'Cadmium Yellow', hex: '#FFF600' },
            { id: 'yellow-ochre', name: 'Yellow Ochre', hex: '#CC7722' },
            { id: 'sap-green', name: 'Sap Green', hex: '#507D2A' },
            { id: 'viridian', name: 'Viridian', hex: '#40826D' },
            { id: 'cobalt', name: 'Cobalt Blue', hex: '#0047AB' },
            { id: 'ultramarine', name: 'Ultramarine', hex: '#4166F5' }, 
            { id: 'burnt-sienna', name: 'Burnt Sienna', hex: '#E97451' },
            { id: 'burnt-umber', name: 'Burnt Umber', hex: '#8A3324' },
            { id: 'paynes', name: 'Payne\'s Grey', hex: '#536878' },
            { id: 'white', name: 'Paper (White)', hex: '#FFFFFF' }, 
        ];

        const INIT_PALETTE = COMMON_PIGMENTS.filter(p => 
            ['cad-red', 'lemon', 'ultramarine', 'burnt-sienna', 'white'].includes(p.id)
        );

        // --- App Component ---
        const App = () => {
            const [targetHex, setTargetHex] = useState('#8B5A2B'); 
            const [palette, setPalette] = useState(INIT_PALETTE);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showTheory, setShowTheory] = useState(false);
            
            const targetRgb = useMemo(() => hexToRgb(targetHex), [targetHex]);
            const targetLab = useMemo(() => rgbToLab(targetRgb), [targetRgb]);

            const bestMix = useMemo(() => {
                let bestDist = Infinity;
                let bestRecipe = null;
                let bestResultHex = '#ffffff';

                const paletteWithRgb = palette.map(p => ({ ...p, rgb: hexToRgb(p.hex) }));

                const checkMix = (indices, parts) => {
                    const selectedColors = indices.map(i => paletteWithRgb[i]);
                    const mixedRgb = mixColors(selectedColors, parts);
                    const mixedLab = rgbToLab(mixedRgb);
                    const dist = deltaE(targetLab, mixedLab);

                    if (dist < bestDist) {
                        bestDist = dist;
                        bestResultHex = rgbToHex(mixedRgb.r, mixedRgb.g, mixedRgb.b);
                        bestRecipe = indices.map((idx, i) => ({
                            color: palette[idx],
                            parts: parts[i]
                        }));
                    }
                };

                for (let i = 0; i < paletteWithRgb.length; i++) checkMix([i], [1]);
                
                const ratios2 = [[1,1], [2,1], [1,2], [3,1], [1,3], [10,1], [1,10]];
                for (let i = 0; i < paletteWithRgb.length; i++) {
                    for (let j = i + 1; j < paletteWithRgb.length; j++) {
                        for (let r of ratios2) checkMix([i, j], r);
                    }
                }

                if (bestDist > 10) { 
                    const ratios3 = [[1,1,1], [2,1,1], [1,2,1]];
                    for (let i = 0; i < paletteWithRgb.length; i++) {
                        for (let j = i + 1; j < paletteWithRgb.length; j++) {
                            for (let k = j + 1; k < paletteWithRgb.length; k++) {
                                for (let r of ratios3) checkMix([i, j, k], r);
                            }
                        }
                    }
                }

                return { recipe: bestRecipe, resultHex: bestResultHex, accuracy: Math.max(0, 100 - bestDist * 2) };
            }, [targetHex, palette, targetLab]);

            const addToPalette = (pigment) => {
                if (!palette.some(p => p.id === pigment.id)) setPalette([...palette, pigment]);
                setShowAddModal(false);
            };

            const removeFromPalette = (id) => {
                setPalette(palette.filter(p => p.id !== id));
            };

            return (
                <div className="min-h-screen bg-stone-50 pb-20">
                    <header className="bg-white border-b border-stone-200 sticky top-0 z-20 px-4 py-3 shadow-sm flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-500 text-white p-2 rounded-lg">
                                <Droplets size={20} />
                            </div>
                            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">
                                Watercolor Wizard
                            </h1>
                        </div>
                        <button onClick={() => setShowTheory(!showTheory)} className="text-slate-500 hover:text-blue-600 transition-colors">
                            <BookOpen size={24} />
                        </button>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-6">
                        <section className="bg-white rounded-2xl p-6 shadow-sm border border-stone-100">
                            <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">1. What color do you want?</h2>
                            <div className="flex gap-4 items-center">
                                <div className="relative flex-1">
                                    <input type="color" value={targetHex} onChange={(e) => setTargetHex(e.target.value)} className="opacity-0 absolute inset-0 w-full h-full cursor-pointer z-10" />
                                    <div className="h-24 rounded-xl shadow-inner border border-stone-200 w-full flex items-center justify-center text-white font-medium transition-colors" style={{ backgroundColor: targetHex, textShadow: '0 1px 2px rgba(0,0,0,0.3)' }}>
                                        Tap to Pick
                                    </div>
                                </div>
                            </div>
                        </section>

                        <section>
                            <div className="flex items-center justify-between mb-3">
                                <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider">2. Your Palette</h2>
                                <button onClick={() => setShowAddModal(true)} className="text-xs bg-stone-100 hover:bg-stone-200 text-stone-600 px-3 py-1 rounded-full font-medium transition-colors">
                                    + Add Paint
                                </button>
                            </div>
                            <div className="flex flex-wrap gap-3 bg-white p-4 rounded-2xl border border-stone-100 shadow-sm min-h-[100px]">
                                {palette.map(p => (
                                    <div key={p.id} className="relative group">
                                        <button 
                                            onClick={() => removeFromPalette(p.id)}
                                            className={`w-12 h-12 rounded-full shadow-sm border-2 relative overflow-hidden transition-transform active:scale-95 ${p.id !== 'white' ? 'group-hover:opacity-70' : ''}`}
                                            style={{ backgroundColor: p.hex, borderColor: 'rgba(0,0,0,0.1)' }}
                                        >
                                           <div className="absolute inset-0 opacity-20 pointer-events-none mix-blend-multiply" style={{backgroundImage: `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.5'/%3E%3C/svg%3E")`}}></div>
                                        </button>
                                        {p.id !== 'white' && (
                                            <div className="absolute -top-1 -right-1 pointer-events-none opacity-0 group-hover:opacity-100 text-red-500 bg-white rounded-full shadow-md"><XIcon size={12}/></div>
                                        )}
                                    </div>
                                ))}
                                <button onClick={() => setShowAddModal(true)} className="w-12 h-12 rounded-full border-2 border-dashed border-stone-300 flex items-center justify-center text-stone-400 hover:border-blue-400 hover:text-blue-400 transition-colors">
                                    <Plus size={20} />
                                </button>
                            </div>
                        </section>

                        <section className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 shadow-md border border-blue-100 relative overflow-hidden">
                            <h2 className="text-sm font-semibold text-blue-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                                <RefreshCw size={14} className={bestMix.recipe ? "" : "animate-spin"} />
                                Mixing Recipe
                            </h2>
                            <div className="flex items-center justify-center gap-6 mb-8 relative z-10">
                                <div className="text-center">
                                    <div className="w-16 h-16 rounded-full shadow-sm mb-2 border-2 border-white" style={{backgroundColor: targetHex}}></div>
                                    <span className="text-xs text-slate-500 font-medium">Goal</span>
                                </div>
                                <div className="text-slate-300">âžœ</div>
                                <div className="text-center relative">
                                    <div className="w-16 h-16 rounded-full shadow-sm mb-2 border-2 border-white" style={{backgroundColor: bestMix.resultHex}}></div>
                                    <span className="text-xs text-slate-500 font-medium">Result</span>
                                    <div className={`absolute -top-2 -right-4 px-2 py-0.5 rounded-full text-[10px] font-bold text-white shadow-sm ${bestMix.accuracy > 90 ? 'bg-green-500' : bestMix.accuracy > 80 ? 'bg-yellow-500' : 'bg-orange-400'}`}>
                                        {Math.round(bestMix.accuracy)}%
                                    </div>
                                </div>
                            </div>
                            <div className="space-y-3 bg-white/60 p-4 rounded-xl backdrop-blur-sm relative z-10">
                                {bestMix.recipe && bestMix.recipe.map((step, idx) => (
                                    <div key={idx} className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full border border-stone-200 shadow-sm" style={{backgroundColor: step.color.hex}}></div>
                                            <span className="font-medium text-slate-700">{step.color.name}</span>
                                        </div>
                                        <div className="text-right">
                                            <span className="text-lg font-bold text-blue-600">{step.parts}</span>
                                            <span className="text-xs text-slate-400 ml-1 uppercase">part{step.parts > 1 ? 's' : ''}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    </main>

                    {showAddModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate-slide-in-right md:animate-none">
                                <div className="p-4 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                                    <h3 className="font-bold text-lg text-slate-700">Add to Palette</h3>
                                    <button onClick={() => setShowAddModal(false)} className="p-2 hover:bg-stone-200 rounded-full transition"><XIcon size={18}/></button>
                                </div>
                                <div className="p-4 max-h-[60vh] overflow-y-auto space-y-2">
                                    {COMMON_PIGMENTS.filter(cp => !palette.some(p 
