<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Watercolor Wizard</title>
    <!-- Tailwind CSS (Styling only, very safe) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-stone-50 text-slate-800 font-sans pb-20 select-none">

    <!-- HEADER -->
    <header class="bg-white border-b border-stone-200 sticky top-0 z-30 px-4 py-3 shadow-sm flex items-center justify-between">
        <div class="flex items-center gap-2">
            <div class="bg-blue-500 text-white p-2 rounded-lg">
                <!-- Icon: Droplet -->
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></svg>
            </div>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">Watercolor Wiz</h1>
        </div>
        <button onclick="toggleTheory()" class="text-slate-500 hover:text-blue-600 p-2">
            <!-- Icon: Book -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        </button>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">

        <!-- 1. TARGET SELECTOR -->
        <section class="bg-white rounded-2xl p-6 shadow-sm border border-stone-100">
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">1. Pick Target Color</h2>
            <div class="relative h-24 rounded-xl shadow-inner border border-stone-200 w-full overflow-hidden group">
                <!-- The actual color input is invisible but covers the area -->
                <input type="color" id="colorInput" value="#8B5A2B" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" oninput="updateTarget(this.value)">
                
                <!-- The visual display -->
                <div id="colorDisplay" class="absolute inset-0 flex items-center justify-center text-white font-bold text-shadow-sm transition-colors duration-100" style="background-color: #8B5A2B; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">
                    Tap Here
                </div>
            </div>
        </section>

        <!-- 2. PALETTE -->
        <section>
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider">2. Your Palette</h2>
                <button onclick="toggleModal(true)" class="text-xs bg-stone-100 text-stone-600 px-3 py-1 rounded-full font-medium hover:bg-blue-100 hover:text-blue-600 transition-colors">
                    + Add Paint
                </button>
            </div>
            <div id="paletteContainer" class="flex flex-wrap gap-3 bg-white p-4 rounded-2xl border border-stone-100 shadow-sm min-h-[80px]">
                <!-- Palette items injected here by JS -->
            </div>
        </section>

        <!-- 3. RESULTS -->
        <section class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 shadow-md border border-blue-100">
            <h2 class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                Best Mix Recipe
            </h2>
            
            <div id="resultContainer">
                <!-- Results injected here by JS -->
            </div>
        </section>

    </main>

    <!-- MODAL (Add Paint) -->
    <div id="addModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="toggleModal(false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-xl w-[90%] max-w-sm overflow-hidden fade-in">
            <div class="p-4 border-b border-stone-100 flex justify-between bg-stone-50 items-center">
                <h3 class="font-bold text-slate-700">Add to Palette</h3>
                <button onclick="toggleModal(false)" class="p-2 hover:bg-stone-200 rounded-full">
                    <svg width="20" height="20" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div id="modalList" class="p-2 max-h-[60vh] overflow-y-auto">
                <!-- List injected here -->
            </div>
        </div>
    </div>

    <!-- THEORY SLIDE-OVER -->
    <div id="theoryModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="toggleTheory()"></div>
        <div class="absolute right-0 top-0 bottom-0 w-full max-w-sm bg-white shadow-2xl p-6 overflow-y-auto fade-in">
            <button onclick="toggleTheory()" class="absolute top-4 right-4 p-2 bg-stone-100 rounded-full">
                <svg width="20" height="20" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <h2 class="text-xl font-bold mb-6 text-blue-600 flex items-center gap-2">
                Watercolor Tips
            </h2>
            <div class="space-y-6 text-sm text-slate-600">
                <div class="bg-blue-50 p-4 rounded-xl">
                    <h3 class="font-bold text-slate-800 mb-1">1. The "Mud" Rule</h3>
                    <p>Mixing opposites creates mud/shadows. <br>Red + Green = Grey/Brown.<br>Use this for shadows instead of Black!</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-xl">
                    <h3 class="font-bold text-slate-800 mb-1">2. Water is White</h3>
                    <p>In this app, adding "Paper (White)" means adding water to dilute the pigment and let the paper show through.</p>
                </div>
                <div class="bg-red-50 p-4 rounded-xl">
                    <h3 class="font-bold text-slate-800 mb-1">3. Warm vs Cool</h3>
                    <p>To make vibrant Purple, use Cool Red (Alizarin) + Warm Blue (Ultramarine). Other combos might look dull.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN LOGIC (Standard JS) -->
    <script>
        // --- DATA ---
        const PIGMENTS = [
            { id: 'cad-red', name: 'Cadmium Red', hex: '#E30022' },
            { id: 'alizarin', name: 'Alizarin Crimson', hex: '#E32636' },
            { id: 'lemon', name: 'Lemon Yellow', hex: '#FFF44F' },
            { id: 'cad-yellow', name: 'Cadmium Yellow', hex: '#FFF600' },
            { id: 'yellow-ochre', name: 'Yellow Ochre', hex: '#CC7722' },
            { id: 'sap-green', name: 'Sap Green', hex: '#507D2A' },
            { id: 'viridian', name: 'Viridian', hex: '#40826D' },
            { id: 'cobalt', name: 'Cobalt Blue', hex: '#0047AB' },
            { id: 'ultramarine', name: 'Ultramarine', hex: '#4166F5' }, 
            { id: 'burnt-sienna', name: 'Burnt Sienna', hex: '#E97451' },
            { id: 'burnt-umber', name: 'Burnt Umber', hex: '#8A3324' },
            { id: 'paynes', name: 'Payne\'s Grey', hex: '#536878' },
            { id: 'white', name: 'Paper (White)', hex: '#FFFFFF' }, 
        ];

        // --- STATE ---
        let state = {
            targetHex: '#8B5A2B',
            paletteIds: ['cad-red', 'lemon', 'ultramarine', 'burnt-sienna', 'white']
        };

        // --- COLOR MATH HELPERS ---
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:0,g:0,b:0};
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function rgbToLab(rgb) {
            let r = rgb.r / 255, g = rgb.g / 255, b = rgb.b / 255;
            r = (r > 0.04045) ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
            g = (g > 0.04045) ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
            b = (b > 0.04045) ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;
            let x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
            let y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.00000;
            let z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;
            x = (x > 0.008856) ? Math.pow(x, 1/3) : (7.787 * x) + 16/116;
            y = (y > 0.008856) ? Math.pow(y, 1/3) : (7.787 * y) + 16/116;
            z = (z > 0.008856) ? Math.pow(z, 1/3) : (7.787 * z) + 16/116;
            return { L: (116 * y) - 16, a: 500 * (x - y), b: 200 * (y - z) };
        }

        function mixColors(colors, ratios) {
            let totalRatio = ratios.reduce((a, b) => a + b, 0);
            let avgR = 0, avgG = 0, avgB = 0;
            colors.forEach((c, i) => {
                const rgb = hexToRgb(c.hex);
                avgR += rgb.r * (ratios[i] / totalRatio);
                avgG += rgb.g * (ratios[i] / totalRatio);
                avgB += rgb.b * (ratios[i] / totalRatio);
            });
            const isWhiteMix = colors.every(c => c.id === 'white');
            const darkness = isWhiteMix ? 1.0 : 0.92; 
            return { 
                r: Math.round(avgR * darkness), 
                g: Math.round(avgG * darkness), 
                b: Math.round(avgB * darkness) 
            };
        }

        // --- CORE ALGORITHM ---
        function calculateBestMix() {
            const targetLab = rgbToLab(hexToRgb(state.targetHex));
            const currentPalette = state.paletteIds.map(id => PIGMENTS.find(p => p.id === id));
            
            let bestDist = Infinity;
            let bestRecipe = null;
            let bestHex = '#ffffff';

            const check = (indices, parts) => {
                const selected = indices.map(i => currentPalette[i]);
                const mixedRgb = mixColors(selected, parts);
                const mixedLab = rgbToLab(mixedRgb);
                // Delta E approximation
                const dist = Math.sqrt(
                    (targetLab.L - mixedLab.L)**2 + 
                    (targetLab.a - mixedLab.a)**2 + 
                    (targetLab.b - mixedLab.b)**2
                );

                if (dist < bestDist) {
                    bestDist = dist;
                    bestHex = rgbToHex(mixedRgb.r, mixedRgb.g, mixedRgb.b);
                    bestRecipe = indices.map((idx, i) => ({ name: currentPalette[idx].name, hex: currentPalette[idx].hex, parts: parts[i] }));
                }
            };

            // 1 Color
            for (let i = 0; i < currentPalette.length; i++) check([i], [1]);
            
            // 2 Colors
            const r2 = [[1,1], [2,1], [1,2], [4,1], [1,4]];
            for (let i = 0; i < currentPalette.length; i++) {
                for (let j = i + 1; j < currentPalette.length; j++) {
                    for (let r of r2) check([i, j], r);
                }
            }

            // 3 Colors (if needed)
            if (bestDist > 10) {
                const r3 = [[1,1,1], [2,1,1], [1,2,1], [1,1,2]];
                for (let i = 0; i < Math.min(currentPalette.length, 6); i++) {
                    for (let j = i + 1; j < currentPalette.length; j++) {
                        for (let k = j + 1; k < currentPalette.length; k++) {
                            for (let r of r3) check([i, j, k], r);
                        }
                    }
                }
            }

            return {
                recipe: bestRecipe,
                resultHex: bestHex,
                accuracy: Math.max(0, Math.round(100 - bestDist * 1.5))
            };
        }

        // --- RENDER FUNCTIONS ---
        function renderPalette() {
            const container = document.getElementById('paletteContainer');
            let html = '';
            
            state.paletteIds.forEach(id => {
                const p = PIGMENTS.find(pig => pig.id === id);
                html += `
                    <div class="relative group" onclick="${id !== 'white' ? `removePigment('${id}')` : ''}">
                        <div class="w-12 h-12 rounded-full border-2 shadow-sm transition-transform active:scale-95 relative overflow-hidden" 
                             style="background-color: ${p.hex}; border-color: rgba(0,0,0,0.1);">
                             <!-- Texture overlay -->
                             <div class="absolute inset-0 opacity-20" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNjY2MiLz4KPC9zdmc+'); opacity: 0.2"></div>
                        </div>
                        ${id !== 'white' ? `<div class="absolute -top-1 -right-1 bg-white text-red-500 rounded-full shadow p-0.5"><svg width="12" height="12" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3" fill="none"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>` : ''}
                    </div>
                `;
            });

            html += `
                <button onclick="toggleModal(true)" class="w-12 h-12 rounded-full border-2 border-dashed border-stone-300 flex items-center justify-center text-stone-400">
                    <svg width="20" height="20" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
            `;
            container.innerHTML = html;
        }

        function renderResults() {
            const mix = calculateBestMix();
            const container = document.getElementById('resultContainer');
            
            // Visual Comparison
            let html = `
                <div class="flex items-center justify-center gap-6 mb-6">
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full border-2 border-white shadow-sm mx-auto mb-1" style="background-color: ${state.targetHex}"></div>
                        <span class="text-xs text-slate-500">Goal</span>
                    </div>
                    <div class="text-slate-300 text-xl">âžœ</div>
                    <div class="text-center relative">
                        <div class="w-16 h-16 rounded-full border-2 border-white shadow-sm mx-auto mb-1" style="background-color: ${mix.resultHex}"></div>
                        <span class="text-xs text-slate-500">Result</span>
                        <div class="absolute -top-2 -right-4 ${mix.accuracy > 85 ? 'bg-green-500' : 'bg-yellow-500'} text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">
                            ${mix.accuracy}% Match
                        </div>
                    </div>
                </div>
                <div class="bg-white/60 p-4 rounded-xl space-y-3 backdrop-blur-sm">
            `;

            // Recipe List
            if (mix.recipe) {
                mix.recipe.forEach(step => {
                    html += `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full border border-stone-200" style="background-color: ${step.hex}"></div>
                                <span class="font-medium text-slate-700 text-sm">${step.name}</span>
                            </div>
                            <div>
                                <span class="text-lg font-bold text-blue-600">${step.parts}</span>
                                <span class="text-[10px] text-slate-400 uppercase ml-1">Part</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderModal() {
            const list = document.getElementById('modalList');
            let html = '';
            
            // Filter pigments not in palette
            const available = PIGMENTS.filter(p => !state.paletteIds.includes(p.id));
            
            if (available.length === 0) {
                html = '<div class="text-center py-4 text-slate-400 text-sm">You have all the paints!</div>';
            } else {
                available.forEach(p => {
                    html += `
                        <button onclick="addPigment('${p.id}')" class="w-full flex items-center gap-3 p-3 hover:bg-blue-50 rounded-xl transition-colors border-b border-stone-50 last:border-0">
                            <div class="w-8 h-8 rounded-full border border-stone-200" style="background-color: ${p.hex}"></div>
                            <span class="font-medium text-slate-700">${p.name}</span>
                            <div class="ml-auto text-stone-300">
                                <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            </div>
                        </button>
                    `;
                });
            }
            list.innerHTML = html;
        }

        // --- ACTIONS ---
        window.updateTarget = (hex) => {
            state.targetHex = hex;
            document.getElementById('colorDisplay').style.backgroundColor = hex;
            renderResults();
        };

        window.addPigment = (id) => {
            if (!state.paletteIds.includes(id)) {
                state.paletteIds.push(id);
                renderPalette();
                renderResults(); // Mix might change if new color helps
                renderModal(); // Update modal list
                toggleModal(false);
            }
        };

        window.removePigment = (id) => {
            if (id === 'white') return; // Cannot remove white
            state.paletteIds = state.paletteIds.filter(pid => pid !== id);
            renderPalette();
            renderResults();
        };

        window.toggleModal = (show) => {
            const modal = document.getElementById('addModal');
            if (show) {
                renderModal();
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        };

        window.toggleTheory = () => {
            const modal = document.getElementById('theoryModal');
            modal.classList.toggle('hidden');
        };

        // --- INIT ---
        renderPalette();
        renderResults();

    </script>
</body>
</html>


